<ng-container *ngIf="elm.figure.ext === 'dyn'">
  <kd-viewport *ngIf="dS.isBrowser" [elm]="elm"></kd-viewport>

  <figcaption *ngIf="elm.view === 'none'" class="figcaption">
    <div>
      <div (click)="dS.edit(elm)" class="kd-numeration">
        <span [class.hover-pointer]="pS.profile.role.editor">
          {{ dS.system.txts.FIGURE_ABR }} {{ node.no }}
        </span>
      </div>
      <div class="cell-caption-figure">
        <kd-text [elm]="elm" [parent]="parent" [pos]="'cpt'"></kd-text>
      </div>
    </div>
  </figcaption>
</ng-container>
<ng-container *ngIf="elm.figure.ext === 'svg'">
  <div [innerHTML]="elm.figure.render | safeHtml"></div>

  <figcaption *ngIf="elm.view === 'none'" class="figcaption">
    <div>
      <div (click)="dS.edit(elm)" class="kd-numeration">
        <span [class.hover-pointer]="pS.profile.role.editor">
          {{ dS.system.txts.FIGURE_ABR }} {{ node.no }}
        </span>
      </div>
      <div class="cell-caption-figure">
        <kd-text [elm]="elm" [parent]="parent" [pos]="'cpt'"></kd-text>
      </div>
    </div>
  </figcaption>
</ng-container>

<!-- [class.kd-img-border]="!elm.figure.borderless && !grid" -->

<figure
  *ngIf="
    elm.figure.ext === 'jpg' ||
    elm.figure.ext === 'png' ||
    elm.figure.ext === 'mp4' ||
    elm.figure.ext === 'mov'
  "
  [class.fig-grid]="grid"
  [class.title-figure]="viewDepth === 0 && elm.children"
>
  <ng-container *ngIf="!isFullscreen">
    <div
      [class.bdy-indent]="!grid"
      [class.kd-img-border]="
        !elm.figure.borderless &&
        !grid &&
        elm.figure.ext !== 'mov' &&
        elm.figure.ext !== 'mp4'
      "
      [style.max-width]="
        (set.figure?.customSize || dS.style.sizes[size].width) + 'px'
      "
      [style.max-height]="
        set.figure?.customSize ||
        dS.style.sizes[size].width / (figure?.mratio || elm.figure?.ratio) +
          'px'
      "
      class="img-container"
    >
      <ng-container *ngIf="vS.userAgentIsBot === true; else noBot">
        <img
          *ngIf="elm.figure.ext === 'jpg' || elm.figure.ext === 'png'"
          [src]="
            '/images/scaled/' +
            elm._eid.str +
            '-' +
            (set.figure?.customSize ||
              dS.style.sizes[size].width * (figure.magnification || 1.0)
              | number : '1.0-0' : 'de') +
            dS.retina.suffix +
            '.' +
            elm.figure.ext +
            '?cachebust=' +
            elm.figure.version
          "
          [alt]="elm.txts.lbl"
          [width]="
            set.figure?.customSize ||
            dS.style.sizes[size].width * (figure.magnification || 1.0)
          "
          [height]="
            (set.figure?.customSize ||
              dS.style.sizes[size].width * (figure.magnification || 1.0)) /
            elm.figure.ratio
          "
          (click)="toggleFullScreen()"
          class="hover-pointer"
          style="position: relative"
          [style.top]="(figure.top || 0) + 'px'"
          [style.left]="(figure.left || 0) + 'px'"
          [class.themed]="elm.figure.themed"
        />
      </ng-container>

      <ng-template #noBot>
        <div
          *ngIf="
            !elm.figure.image &&
            (elm.figure.ext === 'jpg' || elm.figure.ext === 'png')
          "
          [style.width]="
            (set.figure?.customSize ||
              dS.style.sizes[size].width * (figure.magnification || 1.0)) + 'px'
          "
          [style.height]="
            (set.figure?.customSize ||
              dS.style.sizes[size].width * (figure.magnification || 1.0)) /
              elm.figure.ratio +
            'px'
          "
          style="position: relative"
          [style.top]="(figure.top || 0) + 'px'"
          [style.left]="(figure.left || 0) + 'px'"
        >
          Â 
        </div>
        <img
          *ngIf="elm.figure.image"
          [src]="
            dS.domSanitizer.bypassSecurityTrustResourceUrl(elm.figure.image)
          "
          [alt]="elm.txts.lbl"
          [width]="
            set.figure?.customSize ||
            dS.style.sizes[size].width * (figure.magnification || 1.0)
          "
          [height]="
            (set.figure?.customSize ||
              dS.style.sizes[size].width * (figure.magnification || 1.0)) /
            elm.figure.ratio
          "
          (click)="toggleFullScreen()"
          class="hover-pointer"
          style="position: relative"
          [style.top]="(figure.top || 0) + 'px'"
          [style.left]="(figure.left || 0) + 'px'"
          [class.themed]="elm.figure.themed"
        />
      </ng-template>
      <video
        *ngIf="elm.figure.ext === 'mp4' || elm.figure.ext === 'mov'"
        [src]="'/videos/' + elm._eid.str + '.' + elm.figure.ext"
        [width]="dS.style.sizes[elm.figure.size].width"
        [height]="dS.style.sizes[elm.figure.size].width / elm.figure.ratio"
        controls
        [loop]="elm.figure.loop"
        [autoplay]="elm.figure.autoplay"
        [muted]="elm.figure.muted"
        class="noSelect"
      >
        <!-- <source [src]="'/media/'+elm._eid.str+'.'+ elm.figure.ext" type="video/mp4"> -->
        Your browser does not support the video tag.
      </video>
    </div>
  </ng-container>
  <div *ngIf="isFullscreen" (click)="toggleFullScreen()" class="kd-full-view">
    <img
      [src]="
        '/images/scaled/' +
        elm._eid.str +
        '-' +
        dS.style.sizes[6].width +
        dS.retina.suffix +
        '.' +
        elm.figure.ext
      "
      alt="Place image title"
      (click)="toggleFullScreen()"
      class="hover-pointer"
      [class.themed]="elm.figure.themed"
    />
  </div>

  <figcaption
    *ngIf="viewDepth > 0 && !grid && node.elm.txts.cpt"
    class="figcaption"
  >
    <div>
      <div (click)="dS.edit(elm)" class="kd-numeration">
        <span [class.hover-pointer]="pS.profile.role.editor">
          <span *ngIf="elm.figure.ext === 'png' || elm.figure.ext === 'jpg'">{{
            dS.system.txts.FIGURE_ABR
          }}</span>
          <span *ngIf="elm.figure.ext === 'mp4' || elm.figure.ext === 'mov'">{{
            dS.system.txts.VIDEO_ABR
          }}</span>
          <span> {{ node.no }}</span>
        </span>
      </div>
      <div class="cell-caption-figure">
        <kd-text [node]="node" [parent]="parent" [pos]="'cpt'"></kd-text>
      </div>
    </div>
  </figcaption>

  <figcaption
    *ngIf="
      (viewDepth === 0 && elm.txts.cpt) || (viewDepth === 0 && !elm.children)
    "
    class="figcaption"
  >
    <div (click)="dS.edit(elm)" class="kd-numeration">
      <span [class.hover-pointer]="pS.profile.role.editor">
        {{ dS.system.txts.FIGURE_ABR }} {{ node.no }}
      </span>
    </div>
    <div class="cell-caption-figure">
      <kd-text [elm]="elm" [parent]="parent" [pos]="'cpt'"></kd-text>
    </div>
  </figcaption>
</figure>

<div #viewPort *ngIf="elm.figure.construct" class="aspect-16-9">
  <kd-viewport-input [elm]="elm"></kd-viewport-input>
</div>
